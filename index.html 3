<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GrewSolar HR Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#f4f6f8;margin:0}
.box{max-width:420px;margin:60px auto;background:#fff;padding:25px;border-radius:8px}
input,textarea,button{width:100%;padding:10px;margin:6px 0}
button{background:#2e7d32;color:#fff;border:none;cursor:pointer}
nav{background:#1b5e20;color:#fff;padding:12px;text-align:center;font-size:18px}
.section{display:none;padding:20px}
.chat{border:1px solid #ccc;height:200px;overflow:auto;padding:10px}
.msg{margin:5px 0}
.admin{color:red;font-weight:bold}
</style>
</head>

<body>

<nav>GrewSolar Energy Pvt. Ltd. – HR System</nav>

<!-- LOGIN -->
<div class="box" id="loginBox">
<h2>Login / Register</h2>
<input id="email" type="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="register()">Register</button>
<p id="msg"></p>
</div>

<!-- DASHBOARD -->
<div class="section" id="dashboard">
<h2>Dashboard</h2>
<button onclick="logout()">Logout</button>

<h3>Create Ticket</h3>
<input id="tTitle" placeholder="Title">
<textarea id="tDesc" placeholder="Description"></textarea>
<button onclick="createTicket()">Submit Ticket</button>

<h3>Your Tickets</h3>
<ul id="ticketList"></ul>

<h3>Live Chat</h3>
<div class="chat" id="chatBox"></div>
<input id="chatMsg" placeholder="Message">
<button onclick="sendChat()">Send</button>

<h3 id="adminPanel" class="admin" style="display:none">
ADMIN PANEL ENABLED
</h3>
</div>

<script>
/* ✅ CORRECT SUPABASE CONFIG */
const supabase = window.supabase.createClient(
  "https://drjkjnqzldxsyhdzeoe.supabase.co",
  "sb_publishable_TJOK8wFfjaW6vKsoNsNGZw_QzkZJGlo"
);

/* REGISTER */
async function register(){
  msg.innerText="Registering...";
  const { error } = await supabase.auth.signUp({
    email: email.value,
    password: password.value
  });
  msg.innerText = error ? error.message : "Registered! Please Login";
}

/* LOGIN */
async function login(){
  msg.innerText="Logging in...";
  const { error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if(error){ msg.innerText = error.message; return; }
  loginBox.style.display="none";
  dashboard.style.display="block";
  loadRole();
  loadTickets();
  loadChat();
}

/* LOGOUT */
async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

/* ROLE */
async function loadRole(){
  const { data:{user} } = await supabase.auth.getUser();
  const { data } = await supabase
    .from("user_roles")
    .select("*")
    .eq("user_id",user.id)
    .single();

  if(!data){
    await supabase.from("user_roles")
    .insert({ user_id:user.id, role:"user" });
  }

  if(data?.role==="admin"){
    adminPanel.style.display="block";
  }
}

/* TICKETS */
async function createTicket(){
  const { data:{user} } = await supabase.auth.getUser();
  await supabase.from("tickets").insert({
    user_id:user.id,
    title:tTitle.value,
    description:tDesc.value
  });
  loadTickets();
}

async function loadTickets(){
  const { data:{user} } = await supabase.auth.getUser();
  const { data } = await supabase
    .from("tickets")
    .select("*")
    .eq("user_id",user.id);

  ticketList.innerHTML="";
  data.forEach(t=>{
    ticketList.innerHTML+=`<li>${t.title} - ${t.status}</li>`;
  });
}

/* CHAT */
async function sendChat(){
  const { data:{user} } = await supabase.auth.getUser();
  await supabase.from("chat_messages").insert({
    user_email:user.email,
    message:chatMsg.value
  });
  chatMsg.value="";
}

async function loadChat(){
  supabase.channel("chat")
  .on("postgres_changes",
    {event:"INSERT",schema:"public",table:"chat_messages"},
    payload=>{
      chatBox.innerHTML+=
      `<div class="msg"><b>${payload.new.user_email}:</b> ${payload.new.message}</div>`;
    })
  .subscribe();
}
</script>
</body>
</html>
